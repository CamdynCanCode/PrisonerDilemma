<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prisoner's Dilemma Bot Arena</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --surface2: #1a1a25;
      --border: #2a2a3a;
      --accent: #e8ff47;
      --accent2: #ff4757;
      --text: #e8e8f0;
      --muted: #666680;
      --c-color: #47ffc8;
      --d-color: #ff4757;
      --mono: 'Space Mono', monospace;
      --display: 'Syne', sans-serif;
    }

    body {
      font-family: var(--mono);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
    }

    /* Grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(232,255,71,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(232,255,71,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 24px 80px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    header {
      margin-bottom: 48px;
      position: relative;
    }

    .tag {
      font-size: 10px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 12px;
      display: block;
    }

    h1 {
      font-family: var(--display);
      font-size: clamp(32px, 6vw, 60px);
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.02em;
    }

    h1 span { color: var(--accent); }

    .subtitle {
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      max-width: 500px;
    }

    /* Layout */
    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 700px) { .layout { grid-template-columns: 1fr; } }

    /* Panels */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }

    .panel-title {
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: inline-block; }

    /* Editor */
    #botCode {
      width: 100%;
      height: 240px;
      background: var(--bg);
      color: var(--accent);
      border: none;
      outline: none;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.7;
      padding: 16px;
      resize: vertical;
    }

    #botCode::placeholder { color: var(--muted); }

    /* Reference panel */
    .ref-body { padding: 16px; font-size: 12px; line-height: 1.8; }

    .ref-section { margin-bottom: 14px; }

    .ref-section h3 {
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .ref-row { display: flex; gap: 8px; margin-bottom: 4px; align-items: flex-start; }
    .ref-key { color: var(--accent); min-width: 100px; font-size: 11px; }
    .ref-val { color: var(--muted); font-size: 11px; }

    .payoff-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      margin-top: 4px;
    }

    .payoff-cell {
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 2px;
      font-size: 11px;
    }

    .payoff-cell span { color: var(--accent); }

    /* Controls */
    .controls {
      display: flex;
      gap: 12px;
      padding: 16px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .btn {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 10px 20px;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
      font-weight: 700;
    }

    .btn-primary:hover { background: #fff; transform: translateY(-1px); }

    .btn-secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

    /* Opponent selector */
    .opponent-select {
      font-family: var(--mono);
      font-size: 11px;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 9px 12px;
      border-radius: 2px;
      cursor: pointer;
      outline: none;
      flex: 1;
      min-width: 140px;
    }

    /* Results */
    #results { display: none; }

    .results-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    /* Score banner */
    .score-banner {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 24px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      gap: 16px;
    }

    .score-side { text-align: center; }

    .score-label {
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .score-num {
      font-family: var(--display);
      font-size: 48px;
      font-weight: 800;
      line-height: 1;
    }

    .score-num.win { color: var(--accent); }
    .score-num.lose { color: var(--accent2); }
    .score-num.tie { color: var(--text); }

    .vs-badge {
      font-family: var(--display);
      font-size: 14px;
      font-weight: 800;
      color: var(--muted);
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 2px;
    }

    /* Round table */
    .rounds-table {
      width: 100%;
      border-collapse: collapse;
    }

    .rounds-table th {
      font-size: 9px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 10px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }

    .rounds-table td {
      padding: 10px 16px;
      font-size: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .rounds-table tr:last-child td { border-bottom: none; }

    .rounds-table tr { transition: background 0.1s; }
    .rounds-table tr:hover td { background: var(--surface2); }

    .move-chip {
      display: inline-block;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 2px;
      letter-spacing: 0.1em;
    }

    .move-C { background: rgba(71,255,200,0.15); color: var(--c-color); }
    .move-D { background: rgba(255,71,87,0.15); color: var(--d-color); }

    .pts { color: var(--accent); font-weight: 700; }
    .running-score { color: var(--muted); font-size: 11px; }

    /* Error */
    .error-msg {
      background: rgba(255,71,87,0.1);
      border: 1px solid var(--accent2);
      color: var(--accent2);
      padding: 12px 16px;
      font-size: 12px;
      border-radius: 4px;
      margin-top: 20px;
    }

    /* Presets */
    .presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .preset-btn {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.08em;
      padding: 5px 10px;
      background: var(--surface2);
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.12s;
    }

    .preset-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* Verdict */
    .verdict {
      padding: 16px 24px;
      font-size: 13px;
      color: var(--muted);
      border-top: 1px solid var(--border);
    }

    .verdict strong { color: var(--text); }

    /* Animate in */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in { animation: fadeUp 0.3s ease forwards; }

    /* Round counter */
    .rounds-input {
      font-family: var(--mono);
      font-size: 11px;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 9px 12px;
      border-radius: 2px;
      width: 80px;
      outline: none;
    }

    .rounds-input:focus { border-color: var(--accent); }

    .ctrl-label {
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      align-self: center;
    }
  </style>
</head>
<body>
<div class="container">

  <header>
    <span class="tag">● Game Theory Sandbox</span>
    <h1>Prisoner's<br><span>Dilemma</span> Arena</h1>
    <p class="subtitle">Write a bot in a simple scripting language, pit it against an opponent strategy, and see how it performs over multiple rounds.</p>
  </header>

  <div class="layout">
    <!-- Editor Panel -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Bot Script</span>
        <span class="dot"></span>
      </div>
      <div class="presets">
        <button class="preset-btn" data-preset="titfortat">Tit for Tat</button>
        <button class="preset-btn" data-preset="alwaysC">Always C</button>
        <button class="preset-btn" data-preset="alwaysD">Always D</button>
        <button class="preset-btn" data-preset="grudger">Grudger</button>
        <button class="preset-btn" data-preset="random">Random</button>
        <button class="preset-btn" data-preset="detective">Detective</button>
      </div>
      <textarea id="botCode" spellcheck="false"># Tit For Tat
IF round == 1 THEN
    RETURN C
END
RETURN last</textarea>
      <div class="controls">
        <button class="btn btn-primary" id="runBtn">▶ Run Match</button>
        <select class="opponent-select" id="opponentSelect">
          <option value="random">vs Random Bot</option>
          <option value="alwaysC">vs Always Cooperate</option>
          <option value="alwaysD">vs Always Defect</option>
          <option value="titfortat">vs Tit for Tat</option>
          <option value="grudger">vs Grudger</option>
        </select>
        <span class="ctrl-label">Rounds:</span>
        <input class="rounds-input" type="number" id="roundsInput" value="10" min="1" max="100">
        <button class="btn btn-secondary" id="downloadBtn">↓ Save</button>
      </div>
    </div>

    <!-- Reference Panel -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Language Reference</span>
      </div>
      <div class="ref-body">
        <div class="ref-section">
          <h3>Variables (read-only)</h3>
          <div class="ref-row"><span class="ref-key">round</span><span class="ref-val">Current round number (1-based)</span></div>
          <div class="ref-row"><span class="ref-key">last</span><span class="ref-val">Opponent's last move (C/D or null)</span></div>
          <div class="ref-row"><span class="ref-key">myScore</span><span class="ref-val">Your cumulative score</span></div>
          <div class="ref-row"><span class="ref-key">opponentScore</span><span class="ref-val">Opponent's cumulative score</span></div>
          <div class="ref-row"><span class="ref-key">C / D</span><span class="ref-val">Cooperate / Defect constants</span></div>
          <div class="ref-row"><span class="ref-key">RANDOM()</span><span class="ref-val">Returns 0.0–1.0</span></div>
        </div>
        <div class="ref-section">
          <h3>Syntax</h3>
          <div class="ref-row"><span class="ref-key">RETURN C</span><span class="ref-val">Return a move</span></div>
          <div class="ref-row"><span class="ref-key">x = expr</span><span class="ref-val">Assign variable</span></div>
          <div class="ref-row"><span class="ref-key">IF cond THEN</span><span class="ref-val">Conditional block</span></div>
          <div class="ref-row"><span class="ref-key">ELSE / END</span><span class="ref-val">Block delimiters</span></div>
          <div class="ref-row"><span class="ref-key"># comment</span><span class="ref-val">Line comment</span></div>
        </div>
        <div class="ref-section">
          <h3>Payoff Matrix</h3>
          <div class="payoff-grid">
            <div class="payoff-cell">C,C → <span>3</span>, <span>3</span></div>
            <div class="payoff-cell">C,D → <span>0</span>, 5</div>
            <div class="payoff-cell">D,C → <span>5</span>, 0</div>
            <div class="payoff-cell">D,D → <span>1</span>, <span>1</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="results"></div>

</div>

<script>
// ── Interpreter ──────────────────────────────────────────────────────────────
function runBot(code, context) {
  const lines = code.split("\n").map(l => l.trim());
  const variables = { ...context };
  variables.RANDOM = () => Math.random();
  variables.C = "C";
  variables.D = "D";
  let i = 0;

  function evalExpression(expr) {
    try {
      const keys = Object.keys(variables);
      const values = Object.values(variables);
      return new Function(...keys, "return " + expr)(...values);
    } catch { return 0; }
  }

  function runBlock() {
    while (i < lines.length) {
      let line = lines[i];
      if (!line || line.startsWith("#")) { i++; continue; }
      if (line === "END") { i++; return; }
      if (line.startsWith("RETURN")) {
        const expr = line.replace("RETURN", "").trim();
        return evalExpression(expr);
      }
      if (line.startsWith("IF")) {
        const condition = line.replace("IF", "").replace("THEN", "").trim();
        i++;
        const conditionResult = evalExpression(condition);
        if (conditionResult) {
          const result = runBlock();
          if (result !== undefined) return result;
          if (lines[i] === "ELSE") { i++; skipBlock(); }
        } else {
          skipBlock();
          if (lines[i] === "ELSE") {
            i++;
            const result = runBlock();
            if (result !== undefined) return result;
          }
        }
        continue;
      }
      if (line === "ELSE") { i++; runBlock(); continue; }
      if (line.includes("=")) {
        const [name, expr] = line.split("=");
        variables[name.trim()] = evalExpression(expr.trim());
        i++;
        continue;
      }
      i++;
    }
  }

  function skipBlock() {
    let depth = 1;
    while (i < lines.length && depth > 0) {
      if (lines[i].startsWith("IF")) depth++;
      if (lines[i] === "END") depth--;
      i++;
    }
  }

  const result = runBlock();
  return (result === "C" || result === "D") ? result : "C";
}

// ── Opponent Bots ─────────────────────────────────────────────────────────────
const opponents = {
  random: {
    name: "Random",
    fn: () => Math.random() < 0.5 ? "C" : "D"
  },
  alwaysC: {
    name: "Always Cooperate",
    fn: () => "C"
  },
  alwaysD: {
    name: "Always Defect",
    fn: () => "D"
  },
  titfortat: {
    name: "Tit for Tat",
    fn: (round, oppLast) => round === 1 ? "C" : oppLast
  },
  grudger: {
    name: "Grudger",
    fn: (round, oppLast, oppHistory) => oppHistory.includes("D") ? "D" : "C"
  }
};

// ── Presets ───────────────────────────────────────────────────────────────────
const presets = {
  titfortat: `# Tit for Tat\nIF round == 1 THEN\n    RETURN C\nEND\nRETURN last`,
  alwaysC: `# Always Cooperate\nRETURN C`,
  alwaysD: `# Always Defect\nRETURN D`,
  grudger: `# Grudger: Cooperate until betrayed\nIF round == 1 THEN\n    RETURN C\nEND\nIF last == D THEN\n    RETURN D\nEND\nRETURN C`,
  random: `# Random (50/50)\nIF RANDOM() > 0.5 THEN\n    RETURN C\nEND\nRETURN D`,
  detective: `# Detective\n# Probe first 4 rounds, then adapt\nIF round == 1 THEN\n    RETURN C\nEND\nIF round == 2 THEN\n    RETURN D\nEND\nIF round == 3 THEN\n    RETURN C\nEND\nIF round == 4 THEN\n    RETURN C\nEND\nIF opponentScore > myScore THEN\n    RETURN D\nEND\nRETURN C`
};

// ── Payoff ────────────────────────────────────────────────────────────────────
const payoff = { "C,C":[3,3], "C,D":[0,5], "D,C":[5,0], "D,D":[1,1] };

// ── UI ─────────────────────────────────────────────────────────────────────────
document.querySelectorAll(".preset-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const p = btn.dataset.preset;
    if (presets[p]) document.getElementById("botCode").value = presets[p];
  });
});

document.getElementById("downloadBtn").addEventListener("click", () => {
  const blob = new Blob([document.getElementById("botCode").value], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "my_bot.txt"; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("runBtn").addEventListener("click", () => {
  const botCode = document.getElementById("botCode").value;
  const oppKey = document.getElementById("opponentSelect").value;
  const rounds = Math.min(100, Math.max(1, parseInt(document.getElementById("roundsInput").value) || 10));
  const opp = opponents[oppKey];
  const resultsEl = document.getElementById("results");

  let userState = { last: null, myScore: 0, opponentScore: 0 };
  let oppLast = null;
  let oppHistory = [];
  let rows = "";
  let error = null;

  for (let r = 0; r < rounds; r++) {
    let userMove;
    try {
      userMove = runBot(botCode, {
        round: r + 1,
        last: oppLast,
        myScore: userState.myScore,
        opponentScore: userState.opponentScore
      });
    } catch(e) {
      error = e.message;
      break;
    }

    const botMove = opp.fn(r + 1, userState.last, oppHistory);
    const [uPts, bPts] = payoff[`${userMove},${botMove}`];
    userState.myScore += uPts;
    userState.opponentScore += bPts;
    oppHistory.push(botMove);
    oppLast = botMove;
    userState.last = userMove;

    rows += `<tr>
      <td style="color:var(--muted)">${r+1}</td>
      <td><span class="move-chip move-${userMove}">${userMove}</span></td>
      <td><span class="move-chip move-${botMove}">${botMove}</span></td>
      <td class="pts">+${uPts}</td>
      <td class="running-score">${userState.myScore} — ${userState.opponentScore}</td>
    </tr>`;
  }

  if (error) {
    resultsEl.style.display = "block";
    resultsEl.innerHTML = `<div class="error-msg">⚠ Script error: ${error}</div>`;
    return;
  }

  const my = userState.myScore, op = userState.opponentScore;
  const winClass = my > op ? "win" : my < op ? "lose" : "tie";
  const verdict = my > op
    ? `Your bot <strong>won</strong> by ${my - op} points against ${opp.name}.`
    : my < op
    ? `Your bot <strong>lost</strong> by ${op - my} points against ${opp.name}.`
    : `It's a <strong>tie</strong> against ${opp.name}!`;

  resultsEl.style.display = "block";
  resultsEl.innerHTML = `
    <div class="results-panel animate-in">
      <div class="panel-header">
        <span class="panel-title">Match Results — ${rounds} Rounds</span>
        <span class="dot"></span>
      </div>
      <div class="score-banner">
        <div class="score-side">
          <div class="score-label">Your Bot</div>
          <div class="score-num ${winClass}">${my}</div>
        </div>
        <div class="vs-badge">VS</div>
        <div class="score-side">
          <div class="score-label">${opp.name}</div>
          <div class="score-num ${winClass === 'win' ? 'lose' : winClass === 'lose' ? 'win' : 'tie'}">${op}</div>
        </div>
      </div>
      <table class="rounds-table">
        <thead>
          <tr>
            <th>Round</th>
            <th>Your Move</th>
            <th>Opp Move</th>
            <th>Pts</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="verdict">${verdict}</div>
    </div>`;
});
</script>
</body>
</html>
